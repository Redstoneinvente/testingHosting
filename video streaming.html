<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Embedded Zoom Meeting</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>

    <style>
        table {
            border-collapse: collapse;
            width: 50%;
            margin: 20px auto;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        .main-layout {
            display: inline-flex;
            height: 100%;
            width: 100%;

            overflow: hidden;
        }

        .main-layout-hidden {
            display: none;
            height: 100%;
            width: 100%;

            overflow: hidden;
        }

        .material-symbols-outlined {
            color: var(--on-primary);

            margin: auto;

            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 48
        }

        .zoom-container {
            position: relative;
            overflow: hidden;
            width: 60%;
            height: 60vh;
            /* padding-top: auto;  */
            display: block; /* Initially hide the Zoom container */
            background-color: var(--surface-container);
        }

        .zoom-container-hidden {
            position: relative;
            overflow: hidden;
            width: 100%;
            padding-top: 33.75%; 
            display: none; /* Initially hide the Zoom container */
        }

        .zoom-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
        }

        .chat-container {
            position: relative;
            overflow: hidden;

            width: 38%;
            height: 92vh;

            margin-left: 2%;

            display: block;
            background-color: var(--surface-container);
            /* background-image: url('https://lottie.host/embed/6d9f533f-0c5b-44a8-a2b2-8cc6225c6ad1/FtV8TOZmCg.json'); */
            /* display: flex; */
            align-items:flex-start;
            

            .chat-box {
                margin: 2%;
                width: 90%;
                height: 5%;

                margin-right: 0%;

                border: 1px solid;
                border-radius: 5px;
                border-color: var(--outline-variant);

                background-color: transparent;

                font-size: medium;
                color: var(--primary);
            }

            input[type="text"] { 
                padding-left: 10px;  /* Example: 10 pixels of padding on all sides */
                padding-right: 10px;  /* Example: 10 pixels of padding on all sides */
            }

            .chat-send-btn {
                width: 2.85vw;
                height: 2.85vw;

                margin: 2%;
                margin-left: 1%;

                display: flex;
                align-items: center;

                border-radius: 30%;

                background-color: var(--primary);
            }

            h1 {
                margin-left: 5%;
            }

            table {
                margin-left: 5%;
                margin-right: 5%;
                width: 90%;
            }
        }

        /* Overlay to darken the background */
        .lottie-overlay {
        position: fixed;      /* Stay in place */
        top: 0;
        left: 0;
        width: 100%;          /* Cover the whole screen */
        height: 100%;
        background-color: rgba(0, 0, 0, 0.466); /* Black with 70% opacity */
        z-index: 1000;        /* Ensure it's on top of other elements */
        }

        /* The Lottie player itself */
        lottie-player {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Center the animation */
        width: 100vw;   /* Full viewport width */
        height: 100vh;  /* Full viewport height */
        z-index: 1001;  /* On top of the overlay */
        }

        .error-message {
            position: absolute;
            bottom: 35%;   /* Adjust as needed */
            left: 50%;
            transform: translateX(-50%); 
            text-align: center;
            font-size: 36px;  /* Adjust as needed */
            color: white;
        }

        /* Prevent interactions with anything under the overlay*/
        .lottie-overlay,
        .lottie-overlay * { 
        pointer-events: none; 
        }

        /* Basic Modal Styling */
        .modal {
        display: none; 
        position: fixed;
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 30%;
        }

        .close-btn {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        }

        :root {
          --primary: rgb(101, 85, 143);
          --surface-tint: rgb(101 85 143);
          --on-primary: rgb(255 255 255);
          --primary-container: rgb(233 221 255);
          --on-primary-container: rgb(32 16 71);
          --secondary: rgb(98 91 113);
          --on-secondary: rgb(255 255 255);
          --secondary-container: rgb(232 222 248);
          --on-secondary-container: rgb(30 25 43);
          --on-secondary-container-a: rgba(30 25 43 0.08);
          --tertiary: rgb(126 82 96);
          --on-tertiary: rgb(255 255 255);
          --tertiary-container: rgb(255 217 227);
          --on-tertiary-container: rgb(49 16 29);
          --error: rgb(186 26 26);
          --on-error: rgb(255 255 255);
          --error-container: rgb(255 218 214);
          --on-error-container: rgb(65 0 2);
          --background: rgb(253 247 255);
          --on-background: rgb(29 27 32);
          --surface: rgb(253 247 255);
          --on-surface: rgb(29 27 32);
          --surface-variant: rgb(231 224 235);
          --on-surface-variant: rgb(73 69 78);
          --on-surface-variant-a: rgba(73 69 78 0.08);
          --outline: rgb(122 117 127);
          --outline-variant: rgb(202 196 207);
          --shadow: rgb(0 0 0);
          --scrim: rgb(0 0 0);
          --inverse-surface: rgb(50 47 53);
          --inverse-on-surface: rgb(245 239 247);
          --inverse-primary: rgb(207 189 254);
          --primary-fixed: rgb(233 221 255);
          --on-primary-fixed: rgb(32 16 71);
          --primary-fixed-dim: rgb(207 189 254);
          --on-primary-fixed-variant: rgb(77 61 117);
          --secondary-fixed: rgb(232 222 248);
          --on-secondary-fixed: rgb(30 25 43);
          --secondary-fixed-dim: rgb(203 194 219);
          --on-secondary-fixed-variant: rgb(74 68 88);
          --tertiary-fixed: rgb(255 217 227);
          --on-tertiary-fixed: rgb(49 16 29);
          --tertiary-fixed-dim: rgb(239 184 200);
          --on-tertiary-fixed-variant: rgb(99 59 72);
          --surface-dim: rgb(222 216 224);
          --surface-bright: rgb(253 247 255);
          --surface-container-lowest: rgb(255 255 255);
          --surface-container-low: rgb(248 242 250);
          --surface-container: rgb(242 236 244);
          --surface-container-high: rgb(236 230 238);
          --surface-container-highest: rgb(230 224 233);
        --tint-opacity: 87%;
        --iconsSize: 10px;
        --readMoreSize: 30px;
        --transitionSpeed: 100ms;
      }
    </style>
</head>
<body>
    <div class="lottie-overlay" id="lottieoverlay">
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
        <lottie-player src="https://lottie.host/89f9c266-0467-44db-abd0-0939bbbf6a0d/ww8nnrDH3q.json" background="##fff" speed="1" style="width: 300px; height: 300px" loop autoplay direction="1" mode="normal" id="player">
        </lottie-player>
    </div>

    <div class="lottie-overlay" id="errorLottie" style="display: none;">
        <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
        <div class="error-message">User not registered for this event.</div>
        <lottie-player src="https://lottie.host/9f4c43d8-d8e6-4bde-b8e5-2a2c3a159153/7xEQWGcjWF.json" background="##fff" speed="1" style="width: 300px; height: 300px" autoplay direction="1" mode="normal" id="errorPlayer">
        </lottie-player>
    </div>

    <h1 id="s">Event Title</h1>

    <form id="login-form"> 
        <input type="email" id="email" name="email" placeholder="Email" required>
        <!-- <input type="password" id="password" name="password" placeholder="Password" required> -->
        <button type="submit">Login</button>
    </form>

    <div class="main-layout-hidden" id="mainLayout">
        <div class="zoom-container" id="zoom">
            <iframe src="https://success.zoom.us/wc/join/4853028570?pwd=bUd1dEZvNm51bGJudFByQW02d0kwQT09" allow="camera; microphone; display-capture" id="zoomIframe"></iframe>
        </div>

        <div id="chat-updates"></div> 

        <div class="chat-container">
            <!-- <h2>Leaderboard</h2>
            <input type="text" id="chatText" name="chat-text" placeholder="Chat with others" class="chat-box">
            <div class="chat-send-btn">
                <span class="material-symbols-outlined">
                    send
                </span>
            </div> -->

            <h1>Leaderboard</h1>
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <!-- <div id="userModal" class="modal">
        <div class="modal-content">
          <span class="close-btn" onclick="closeModal()">&times;</span>
          <h2 id="userName"></h2>
          <p id="userEmail"></p>
          <button onclick="connectUser()">Connect</button>
          <button onclick="requestMeeting()">Request Meeting</button>
        </div>
    </div> -->

    <div id="userModal" class="mdc-dialog" role="alertdialog">
        <div class="mdc-dialog__container">
          <div class="mdc-dialog__surface">
            <header class="user-header">
              <img id="userProfilePic" src="https://images.pexels.com/photos/7752812/pexels-photo-7752812.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2" alt="Profile Picture" width="500" height="500" style="object-fit: cover;">
              <div class="user-info">
              </div>
            </header>
            <div class="mdc-dialog__content">
              <p><span class="info-label">Name:</span> <span id="userName"></span></p>
              <p><span class="info-label">Email:</span> <span id="userEmail"></span></p>
              <p><span class="info-label">Country:</span> <span id="userCountry"></span></p>
              <p><span class="info-label">Bio:</span> <span id="userBio"></span></p>
              <p><span class="info-label">Interests:</span> <span id="userInterests"></span></p>
            </div>
            <div class="mdc-dialog__actions">
              <button type="button" class="mdc-button mdc-dialog__button" onclick="connectUser()" id="connectButton">
                <span class="mdc-button__label" id="connectButtonText">Connect</span>
              </button>
              <button type="button" class="mdc-button mdc-dialog__button" onclick="requestMeeting()">
                <span class="mdc-button__label">Request Meeting</span>
              </button>
            </div>
          </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
      </div>      

      <div id="zoomPrompt" class="mdc-dialog" role="alertdialog">
        <div class="mdc-dialog__container">
          <div class="mdc-dialog__surface">
            <header class="user-header">
                <h1 style="margin: 5%;text-align: center;">Link your Zoom!</h1>
            </header>
            <div class="mdc-dialog__content">
              <p><span class="info-label">Link your Zoom account to proceed.</span></p>
            </div>
            <div class="mdc-dialog__actions">
              <button type="button" class="mdc-button mdc-dialog__button" onclick="startZoomOAuth()" id="linkToZoom">
                <span class="mdc-button__label" id="connectButtonText">Link Zoom account</span>
              </button>
            </div>
          </div>
        </div>
        <div class="mdc-dialog__scrim" onclick="startZoomOAuth()"></div>
      </div>  

    <script>
        const loginForm = document.getElementById('login-form');
        const mainLayout = document.getElementById('mainLayout');

        const zoomContainer = document.getElementById('zoom');
        const zoomIframe = document.getElementById('zoomIframe');

        const URL_BASE = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/"; // Replace with your Firebase URL
        const ZOOM_URL = "https://success.zoom.us/wc/join/";

        const leaderboardTable = document.getElementById('leaderboard').querySelector('tbody');
        var pointsUrl = 'https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/0/points.json';
        var attendeesUrl = 'https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/0/attendees.json';

        var userEmail = "";

        var attendeesDatas;

        var usersData = [];

        var thisEvent;

        var canFetch = true;

        const errorPlayer = document.getElementById('errorPlayer');

        const dialog = new mdc.dialog.MDCDialog(document.getElementById('userModal'));
        const zoomLinkPrompt = new mdc.dialog.MDCDialog(document.getElementById('zoomPrompt'));

        const button = document.getElementById("connectButton");

        var linked = false;

        function enableButton() {
            button.removeAttribute("disabled");
        }

        function disableButton() {
            button.disabled = true; 
        }

        errorPlayer.addEventListener('complete', () => {
            hideOverlay(document.getElementById("errorLottie"));
        });

        function getMeetingLinkFromFirebase() {
            const urlParams = new URLSearchParams(window.location.search);
            const meetingId = urlParams.get('meetingId');
            thisMeetingId = meetingId;

            if (meetingId) {
                const firebaseUrl = URL_BASE + meetingId + ".json";

                fetch(firebaseUrl)
                .then(response => response.json())
                .then(data => {
                    thisEvent = data;
                    
                    document.getElementById('s').textContent = data.eventName;
                    if (data && data.link) {
                        zoomIframe.src = ZOOM_URL + data.link;
                    } else {
                        alert("No Meeting Link!");
                        document.getElementById("meetingLink").textContent = "Meeting link not found.";
                    }
                })
                .catch(error => {
                    alert("No Meeting Link!");
                    console.error('Error fetching meeting link:', error);
                    document.getElementById("meetingLink").textContent = "Error fetching meeting link.";
                });
            } else {
                alert("No Meeting Link!");
                document.getElementById("meetingLink").textContent = "Please provide a meeting ID in the URL.";
            }

            hideOverlay(document.getElementById("lottieoverlay"));
        }

        async function fetchData() {
            const urlParams = new URLSearchParams(window.location.search);
            const meetingId = urlParams.get('meetingId');

            pointsUrl = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/" + meetingId + "/points.json";
            attendeesUrl = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/" + meetingId + "/attendees.json";

            while (!canFetch) {
                await new Promise(resolve => setTimeout(resolve, 100)); // Yield control briefly
            }

            const pointsResponse = await fetch(pointsUrl);
            const points = await pointsResponse.json() || [];

            const attendeesResponse = await fetch(attendeesUrl);
            const attendees = await attendeesResponse.json() || [];

            updateLeaderboard(points, attendees);

            // Promise.all([
            //     fetch(pointsUrl),
            //     fetch(attendeesUrl)
            // ])
            // .then(responses => Promise.all(responses.map(res => res.json())))
            // .then(([pointsData, attendeesData]) => {
            //     updateLeaderboard(pointsData, attendeesData);
            // })
            // .catch(error => console.error('Error fetching data:', error));
        }

        async function updateLeaderboard(pointsData, attendeesData) {
            attendeesDatas = attendeesData;

            const entries = Object.entries(pointsData);
            entries.sort((a, b) => b[1] - a[1]); // Sort by points (descending)

            const usersURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users.json";
            
            const nameResponse = await fetch(usersURL);
            const names = await nameResponse.json() || [];

            leaderboardTable.innerHTML = ''; // Clear previous entries

            entries.forEach(([index, points], rank) => {
                const inddex = names.findIndex(person => person.userID === attendeesData[index]);

                const isUser = names[inddex].email === userEmail;

                var name = "";

                if(isUser){
                    currentUser = names[inddex];
                    name = names[inddex].name + " (YOU)";
                    let row = leaderboardTable.insertRow();
                    row.style.backgroundColor = '#E6E6FA';

                    let cell1 = row.insertCell()
                    cell1.textContent = rank + 1;
                    cell1.style.fontWeight = 'bold'; 

                    let cell2 = row.insertCell()
                    cell2.textContent = name;
                    cell2.style.fontWeight = 'bold'; 

                    let cell3 = row.insertCell()
                    cell3.textContent = points;
                    cell3.style.fontWeight = 'bold'; 
                }
                else{
                    name = names[inddex].name || "Unknown"

                    const row = leaderboardTable.insertRow();

                    // Hover effect
                    row.addEventListener('mouseover', function() {
                        row.style.backgroundColor = 'lightgray'; // Change background color on hover
                    });

                    row.addEventListener('mouseout', function() {
                        row.style.backgroundColor = ''; // Reset background color
                    });

                    // Click action
                    row.addEventListener('click', function() {
                        showUser(names[inddex]);
                    });

                    let cell1 = row.insertCell()
                    cell1.textContent = rank + 1;

                    let cell2 = row.insertCell()
                    cell2.textContent = name;

                    let cell3 = row.insertCell()
                    cell3.textContent = points;
                }
            });
        }

        function showUser(user) {
            openModal(user);
        }

        function openModal(user) {
            if (user) {
                currentUserModal = user;

                document.getElementById("userName").textContent = user.name;
                document.getElementById("userEmail").textContent = user.email;

                document.getElementById("userCountry").textContent = user.country;
                document.getElementById("userBio").textContent = user.bio;
                document.getElementById("userInterests").textContent = user.interest;

                const profilePic = document.getElementById("userProfilePic");

                if (profilePic) {
                    profilePic.src = user.profilePic;
                } else {
                    console.error("Profile picture element not found.");
                }

                if(currentUserModal.connections) {
                    if(currentUserModal.connections.find(connection => connection === currentUser.userID)) {
                        connectButtonText.textContent = "Connected!";
                        disableButton();
                    }
                    else{
                        enableButton();
                    }
                }
                else{
                    enableButton();
                }

                dialog.open(); 
            }
        }

        function closeModal() {
            dialog.close(); 
        }

        var currentUserModal;
        var currentUser;
        var thisMeetingId;

        async function connectUser() {
            if(currentUserModal.connections) {
                if(currentUserModal.connections.find(connection => connection === currentUser.userID)) {
                    connectButtonText.textContent = "Connected!";
                    disableButton();
                    return;
                }
            }

            const meetingId = thisMeetingId;
            showOverlay(document.getElementById("lottieoverlay"), "https://lottie.host/89f9c266-0467-44db-abd0-0939bbbf6a0d/ww8nnrDH3q.json", document.getElementById("player"));

            const usersURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users.json";
            var connectionsEventURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/" + meetingId + "/connections.json";

            const usersResponse = await fetch(usersURL);
            const allUsers = await usersResponse.json() || [];

            const inddex2 = allUsers.findIndex(person => person.userID === currentUserModal.userID);

            const user2URL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users/" + inddex2 + "/connections.json";
        
            if (Array.isArray(allUsers[inddex2].pendingMeetings) && allUsers[inddex2].pendingMeetings.length > 0) {
                console.log("Array good");
            } else {
                allUsers[inddex2].pendingMeetings = [];
            }

            const connectionResponse = await fetch(user2URL);
            var connectionThis = await connectionResponse.json() || [];

            connectionThis.push(currentUser.userID);

            const connectionsResponseE = await fetch(connectionsEventURL);
            var connectionsE = await connectionsResponseE.json() || [];

            var indexForConnection = connectionsE.length;

            var thisConnection = new Connection(currentUser.userID, currentUserModal.userID);
            thisConnection.isMeeting = false;

            connectionsE.push(thisConnection);

            await fetch(connectionsEventURL, {
                method: 'PUT',
                body: JSON.stringify(connectionsE)
            });

            await fetch(user2URL, {
                method: 'PUT',
                body: JSON.stringify(connectionThis)
            });

            hideOverlay(document.getElementById("lottieoverlay"));

            connectButtonText.textContent = "Connected!";
            disableButton();
        }

        async function requestMeeting() {
            const meetingId = thisMeetingId;

            showOverlay(document.getElementById("lottieoverlay"), "https://lottie.host/89f9c266-0467-44db-abd0-0939bbbf6a0d/ww8nnrDH3q.json", document.getElementById("player"));

            const usersURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users.json";
            var connectionsEventURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/" + meetingId + "/connections.json";
            
            const usersResponse = await fetch(usersURL);
            const allUsers = await usersResponse.json() || [];

            const connectionsResponse = await fetch(connectionsEventURL);
            var connections = await connectionsResponse.json() || [];

            const inddex = allUsers.findIndex(person => person.userID === currentUser.userID);
            const inddex2 = allUsers.findIndex(person => person.userID === currentUserModal.userID);

            const user1URL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users/" + inddex + "/pendingMeetings.json";
            const user2URL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users/" + inddex2 + "/pendingMeetings.json";
        
            if (Array.isArray(allUsers[inddex].pendingMeetings) && allUsers[inddex].pendingMeetings.length > 0) {
                console.log("Array good");
            } else {
                allUsers[inddex].pendingMeetings = [];
            }

            if (Array.isArray(allUsers[inddex2].pendingMeetings) && allUsers[inddex2].pendingMeetings.length > 0) {
                console.log("Array good");
            } else {
                allUsers[inddex2].pendingMeetings = [];
            }

            var indexForConnection = connections.length;
            var thisMeeting = new Meeting(thisEvent.eventID, indexForConnection);

            var thisConnection = new Connection(currentUser.userID, currentUserModal.userID, true);
            //alert(thisConnection.connectionUsers.initatorUserID.userID);

            allUsers[inddex].pendingMeetings.push(thisMeeting);
            allUsers[inddex2].pendingMeetings.push(thisMeeting);

            thisConnection.isMeeting = true;
            connections.push(thisConnection);

            // var connectionsEventURLSend = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/events/" + meetingId + "/connections/" + indexForConnection + ".json";

            await fetch(connectionsEventURL, {
                method: 'PUT',
                body: JSON.stringify(connections)
            });

            //alert(JSON.stringify(thisConnection));

            await fetch(user1URL, {
                method: 'PUT', // Use PUT to overwrite the entire array
                body: JSON.stringify(allUsers[inddex].pendingMeetings)
            });

            await fetch(user2URL, {
                method: 'PUT', // Use PUT to overwrite the entire array
                body: JSON.stringify(allUsers[inddex2].pendingMeetings)
            });

            //https://lottie.host/5f4420f8-6ecd-4ff4-a996-edf4676793b6/vCRoBP8Vqv.json
            hideOverlay(document.getElementById("lottieoverlay"));
            alert("Meeting Requested! Wait for a confirmation from " + allUsers[inddex2].name);

            //showOverlay(document.getElementById("errorLottie"), "https://lottie.host/5f4420f8-6ecd-4ff4-a996-edf4676793b6/vCRoBP8Vqv.json", document.getElementById("errorPlayer"));

            canFetch=true;
        }

        // Click outside to close
        window.onclick = function(event) {
            const modal = document.getElementById("userModal");
            if (event.target === modal) {
                closeModal();
            }
        }

        function showOverlay(overlay, url, player) {
            const body = document.body;

            overlay.style.display = "block";
            
            player.load(url);
            player.seek(0);
            
            body.style.pointerEvents = "none"; // Disable interactions when the overlay is up
        }

        function hideOverlay(overlay) {
            const body = document.body;

            overlay.style.display = "none";
            body.style.pointerEvents = "auto"; // Re-enable interactions
        }

        async function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function fetchUserData(email){
            const usersURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users.json";
            
            showOverlay(document.getElementById("lottieoverlay"), "https://lottie.host/89f9c266-0467-44db-abd0-0939bbbf6a0d/ww8nnrDH3q.json", document.getElementById("player"));

            var err = false;

            await fetch(usersURL)
                .then(response => response.json())
                .then(data => {
                    // Convert the response JSON to an object
                    usersData = Object.values(data);

                    // Find the user based on the provided email
                    const user = usersData.find(user => user.email === email);

                    if (user) {
                        //check if user linked their zoom account
                        
                        if(!user.userZoomEmail) {
                            //alert("Zoom Error");
                            zoomLinkPrompt.open();
                            hideOverlay(document.getElementById("lottieoverlay"));

                            //await WaitUntilLinked();
                        }

                        // User exists, update the 'name' field in the form
                        mainLayout.classList.remove("main-layout-hidden");
                        mainLayout.classList.add("main-layout");

                        loginForm.style.display = 'none';

                        hideOverlay(document.getElementById("lottieoverlay"));
                    } else {
                        // alert("Not Registered!");
                        hideOverlay(document.getElementById("lottieoverlay"));
                        showOverlay(document.getElementById("errorLottie"), "https://lottie.host/9f4c43d8-d8e6-4bde-b8e5-2a2c3a159153/7xEQWGcjWF.json", document.getElementById("errorPlayer"));
                        err = true;
                    }
                })
            .catch(error => console.error('Error fetching user data:', error));
        }

        async function WaitUntilLinked() {
            return new Promise(resolve => {
                                const intervalId = setInterval(() => {
                                if (linked) {
                                    clearInterval(intervalId);
                                    resolve(); 
                                }
                    }, 100);
            });
        }

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); 

            userEmail = document.getElementById('email').value;

            fetchUserData(userEmail);
        });
    
        //Zoom
        //const clientId = "...";
        const clientSecret = "...";
        const accountId = "...";

        var accessToken = "..."; 
        const subscriptionId = "NLnwdAH2TcSdPWeRycCNEg"; // Find this in your App settings
        var webSocketUrl = "wss://ws.zoom.us/ws?subscriptionId=" + subscriptionId + "&access_token=" + accessToken;
        //var webSocketUrl = "wss://ws.zoom.us/ws?subscriptionId=NLnwdAH2TcSdPWeRycCNEg&access_token=eyJzdiI6IjAwMDAwMSIsImFsZyI6IkhTNTEyIiwidiI6IjIuMCIsImtpZCI6IjI4ZDkyN2JkLTc1MGItNGFlMC1iOGQzLWUwZDNiZWU4MTgyNiJ9.eyJhdWQiOiJodHRwczovL29hdXRoLnpvb20udXMiLCJ1aWQiOiJaTDJXVnk5VlQwdThoRDRtb29USF9BIiwidmVyIjo5LCJhdWlkIjoiOWE0MDMzMWFlYWU3MjlmMWMxNzZlODJjYzY0MjZlYmIiLCJuYmYiOjE3MTA1Njg1NzksImNvZGUiOiJrbmtqMnZMSlI2dURESTZuQ1hJYjJnakZVYjVpMThJUmMiLCJpc3MiOiJ6bTpjaWQ6bHFoSlBEQmFUTldEME1TdFRZeE93IiwiZ25vIjowLCJleHAiOjE3MTA1NzIxNzksInR5cGUiOjMsImlhdCI6MTcxMDU2ODU3OSwiYWlkIjoiZlRZdkdZWmNUcUNKTmZDMDAtWXpJdyJ9.qnCBx1v9hppJIcievL11Y4u3JMo61Nqfg545txF7OflyB796F7bbbmT9LpJ707z5BWLpN0jmlEkC1g7c_i-6Sw";
        var webSocket = new WebSocket(webSocketUrl);

        async function getAccessToken() {
            //const credentials = "bHFoSlBEQmFUTldEME1TdFRZeE93OkxlY0RZQTBoMHN2bmdBTTQ0S3NLek1yUE0xUU1nZ2k0"; // Base64 encoding
            const response = await fetch('https://us-central1-fscproject-c108d.cloudfunctions.net/function-1',
            {
                method: 'POST',
                // headers: {
                //     'Authorization': `Basic ${credentials}`
                // }
            });

            if (response.ok) {
                const data = await response.json();
                return data.access_token; 
            } else {
                throw new Error("Error getting access token" + response.error); 
            }
        }

        webSocket.onopen = () => {
            console.log('WebSocket connection established');

            // Variables to track meeting state and heartbeat
            let meetingStarted = false;
            let heartbeatInterval = null; 

            // ... your existing onmessage handler ...
            console.log(meetingStarted);
            webSocket.onmessage = (event) => {
                //alert(event.data);
                const dataM = JSON.parse(event.data);
                const data = dataM;

                if (data.event === 'meeting.started') {
                    console.log('Meeting started!');
                } else if (data.event === 'chat_message') {
                    console.log('New chat message:', data.payload.message); 
                } else {
                    console.log(data.event + ':', data);
                }

                if (data.event === 'meeting.started') {
                    console.log('Meeting started!');
                    meetingStarted = true;

                    // Start heartbeat if meeting has started
                    if (!heartbeatInterval) { 
                        heartbeatInterval = setInterval(() => {
                            sendHeartbeat();
                        }, 30000); // 30 seconds
                    }
                } else if (data.event === 'meeting.ended') {
                    console.log('Meeting ended!');
                    meetingStarted = false;

                    // Stop heartbeat if meeting has ended
                    if (heartbeatInterval) {
                        clearInterval(heartbeatInterval);
                        heartbeatInterval = null;
                    }
                } 
                // ... the rest of your onmessage handler ...

                webSocket.onerror = function(error) {
                    if(error != undefined){
                        console.log("WebSocket error:", error); 
                    }
                }
            };

            function sendHeartbeat() {
                console.log(meetingStarted);
                if (true) { 
                    // Logic to send the heartbeat message over the WebSocket
                    console.log('Sending heartbeat...'); // Replace with your actual sending code
                } 
            }
        };

        // Usage: 
        function accessTokenGet(){
            getAccessToken()
                .then(accessTokens => {
                    accessToken = accessTokens;
                    //alert(webSocketUrl);

                    webSocket = new WebSocket(webSocketUrl);
                    //alert("" +accessToken);
                })
            .catch(error => console.log("Error fetching token:" + error));
        }

        const clientId = 'pFhcbr_WTP2xuYWzP_5scA'; 
        const redirectUri = 'https://redstoneinvente.github.io/testingHosting/connecting.html'; // Must match your Zoom app settings
        //const intervalId = setInterval(checkForAuthCode, 100);

        //starts the flow
        async function startZoomOAuth() {
            const authUrl = `https://zoom.us/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}`;
            // window.location.href = authUrl; 
            const authWindow = window.open(authUrl, '_blank'); 

            while (!authWindow.location.search.includes('code=')) {
                await delay(10);
            }

            const urlParams = new URLSearchParams(authWindow.location.search);
            const code = urlParams.get('code');
            fetchZoomUserInfo(code); // Pass the code to the callback

            authWindow.close();
        }

        // Handle code returned from Zoom (example using URL query parameters)
        function handleAuthorizationCode() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');

            if (code) {
                fetchZoomUserInfo(code);
            }
        }

        async function fetchZoomUserInfo(code) {
            // Placeholder: Securely exchange code for access token on your backend
            const user = await exchangeCodeForToken(code); 
            
            displayUserInfo(user);
        }

        async function displayUserInfo(data) {
            const userZoomEmail = data.email;
            const userZoomID = data.id;

            const usersURL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users.json";

            showOverlay(document.getElementById("lottieoverlay"), "https://lottie.host/89f9c266-0467-44db-abd0-0939bbbf6a0d/ww8nnrDH3q.json", document.getElementById("player"));

            var err = false;

            const usersResponse = await fetch(usersURL);
            const allUsers = await usersResponse.json() || [];

            const inddex2 = allUsers.findIndex(person => person.userID === currentUser.userID);

            var user = allUsers[inddex2];

            const user1URL = "https://fscproject-c108d-default-rtdb.asia-southeast1.firebasedatabase.app/database/users/" + inddex2 + ".json";

            user.zoomEmail = userZoomEmail;
            user.zoomID = userZoomID;

            await fetch(user1URL, {
                method: 'PUT',
                body: JSON.stringify(user)
            });

            linked = true;
            fetchUserData(currentUser.email);
        }

        async function exchangeCodeForToken(code) {
            const cloudFunctionUrl = 'https://us-central1-fscproject-c108d.cloudfunctions.net/codeToZoomAccessToken';
            const fetchUrl = `${cloudFunctionUrl}?code=${code}&redirectUri=${redirectUri}`;

            try {
                const response = await fetch(fetchUrl);

                if (!response.ok) {
                    alert(`Error from Cloud Function: ${response.status}`);
                }

                const data = await response.json(); // Assuming it returns JSON

                return data; 
            } catch (error) {
                    alert('Error exchanging code:', error); 
                throw error; // Re-throw so you can handle it where you call this function
            }
        }

        // On page load, check if redirected back from Zoom with code
        handleAuthorizationCode(); 

        //Get Access Token
        accessTokenGet();

        // Initial fetch
        fetchData();

        // Option 1: Polling for updates
        setInterval(fetchData, 5000); // Update every 5 seconds

        // Option 1: Polling for updates
        setInterval(accessTokenGet, 3500000); // Update every 5 seconds

        // Call the function when the page loads
        window.onload = getMeetingLinkFromFirebase;

        class Connection {
            constructor(initiator, otherUser, isMeeting) {
                this.connectionUsers = new ConnectionUsers(initiator, otherUser);
                this.isMeeting = isMeeting;
            }

            // Simulate fetching from a database (replace with actual logic)
            async getInitiatorUser(database) { 
                return database.getUser(this.connectionUsers.initatorUserID);
            }

            async getOtherUser(database) {
                return database.getUser(this.connectionUsers.otherUserID);
            }
        }

        class ConnectionUsers {
            constructor(initiator, otherUser) {
                this.initatorUserID = initiator;
                this.otherUserID = otherUser;
            }
        }

        class Meeting {
            constructor(eventId, connectionIndex) {
                this.eventId = eventId;
                this.connectionIndex = connectionIndex;
                this.accepted = false;
            }
        } 
    </script>
</body>
</html>
